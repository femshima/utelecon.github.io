name: Test Report

on:
  workflow_run:
    workflows: ['Jekyll site CI']
    types:
      - completed
jobs:
  report:
    runs-on: ubuntu-latest
    steps:
    - name: Download artifact
      uses: actions/github-script@v6
      with:
        script: |
          let allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
          });
          let matchArtifact = allArtifacts.data.artifacts.filter((artifact) => {
            return artifact.name == "report"
          })[0];
          let download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: matchArtifact.id,
              archive_format: 'zip',
          });
          let fs = require('fs');
          fs.writeFileSync(`${process.env.GITHUB_WORKSPACE}/report.zip`, Buffer.from(download.data));
    - name: Unzip artifact
      run: unzip report.zip
    - name: Upload Check
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs/promises');
          const path = require('path');

          let head_sha = context.sha;
          if (context.eventName === 'workflow_run') {
            head_sha = context.payload.workflow_run.head_commit.id;
          } else if (context.payload.pull_request) {
            head_sha = context.payload.pull_request.head.sha;
          }

          (await fs.readdir('github'))
            .forEach(async filename => {
              const output = JSON.parse(await fs.readFile(path.join('github', filename), 'utf-8'));

              let uploadResult = await github.rest.checks.create({
                head_sha,
                name: output.title,
                conclusion: (output.annotations ?? []).length > 0 ? 'failure' : 'neutral',
                status: 'completed',
                output,
                ...context.repo
              })
              core.info(`Check run '${filename}'`)
              core.info(`  Status: ${uploadResult.status}`)
              core.info(`  URL: ${uploadResult.data.url}`)
              core.info(`  HTML: ${uploadResult.data.html_url}`)
            })

